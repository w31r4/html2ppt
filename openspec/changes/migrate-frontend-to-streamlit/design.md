# Design: Streamlit Frontend Migration

## Context

å½“å‰é¡¹ç›®é‡‡ç”¨ React + TypeScript å‰ç«¯ï¼Œé€šè¿‡ Nginx åå‘ä»£ç†ä¸ FastAPI åç«¯é€šä¿¡ã€‚å‰ç«¯åŒ…å«ä¸€ä¸ªå…³é”®çš„ Vue SFC å®æ—¶é¢„è§ˆåŠŸèƒ½ï¼ˆ`VuePreview.tsx`ï¼‰ï¼Œè¯¥åŠŸèƒ½åœ¨æµè§ˆå™¨ç«¯ç¼–è¯‘å’Œæ¸²æŸ“ Vue ç»„ä»¶ã€‚

ç»´æŠ¤è€…è¡¨ç¤ºä¸ç†Ÿæ‚‰ React æŠ€æœ¯æ ˆï¼Œå¸Œæœ›è¿ç§»åˆ° Python å…¨æ ˆæ–¹æ¡ˆä»¥é™ä½ç»´æŠ¤æˆæœ¬ã€‚

## Goals / Non-Goals

**Goals:**
- å°†å‰ç«¯ä» React è¿ç§»åˆ° Streamlit
- ä¿ç•™ Vue ç»„ä»¶å®æ—¶é¢„è§ˆåŠŸèƒ½
- ä¿æŒç°æœ‰ç”¨æˆ·å·¥ä½œæµä¸å˜
- ç®€åŒ–å¼€å‘å’Œç»´æŠ¤æµç¨‹

**Non-Goals:**
- ä¸ä¿®æ”¹åç«¯ FastAPI API æ¥å£
- ä¸æ”¹å˜ LLM å·¥ä½œæµé€»è¾‘
- ä¸é‡æ–°è®¾è®¡ç”¨æˆ·äº¤äº’æµç¨‹

## Decisions

### Decision 1: ä¸‰æœåŠ¡æ¶æ„

é‡‡ç”¨ä¸‰æœåŠ¡æ¶æ„æ›¿ä»£å½“å‰çš„ä¸¤æœåŠ¡æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      docker-compose                             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   streamlit     â”‚  â”‚     backend     â”‚  â”‚  vue-preview    â”‚ â”‚
â”‚  â”‚   :8501         â”‚â”€â”€â”‚   FastAPI :8000 â”‚  â”‚   Vite :5173    â”‚ â”‚
â”‚  â”‚   ä¸»ç•Œé¢         â”‚  â”‚   çº¯APIæœåŠ¡      â”‚  â”‚  Vueæ¸²æŸ“æœåŠ¡     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚                    â”‚                    â”‚            â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                          nginx :80                               â”‚
â”‚                      (ç»Ÿä¸€å…¥å£ + è·¯ç”±)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è·¯ç”±è§„åˆ™:**
- `/` â†’ Streamlit (ä¸»ç•Œé¢)
- `/api/*` â†’ FastAPI (åç«¯ API)
- `/preview/*` â†’ Vue Preview Service (Vue ç»„ä»¶æ¸²æŸ“)

**Alternatives considered:**
- ä¸¤æœåŠ¡æ–¹æ¡ˆï¼ˆStreamlit å†…åµŒé™æ€é¢„è§ˆï¼‰ï¼šæ— æ³•å®ç°å®æ—¶ Vue æ¸²æŸ“
- å•æœåŠ¡æ–¹æ¡ˆï¼ˆçº¯ Streamlitï¼‰ï¼šå®Œå…¨ä¸§å¤±é¢„è§ˆèƒ½åŠ›

### Decision 2: Vue Preview Service è®¾è®¡

ä»ç°æœ‰ React åº”ç”¨ä¸­æå– `VuePreview.tsx` çš„æ ¸å¿ƒé€»è¾‘ï¼Œåˆ›å»ºç‹¬ç«‹çš„è½»é‡çº§æœåŠ¡ï¼š

```
vue-preview-service/
â”œâ”€â”€ index.html
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts           # å…¥å£
â”‚   â””â”€â”€ VuePreview.ts     # æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ï¼ˆä» VuePreview.tsx ç§»æ¤ï¼‰
â”œâ”€â”€ package.json          # æœ€å°ä¾èµ–ï¼švue, @vue/compiler-sfc, @unocss/core
â”œâ”€â”€ vite.config.ts
â””â”€â”€ Dockerfile
```

**é€šä¿¡åè®®:**
- Streamlit é€šè¿‡ `st.components.v1.iframe()` åµŒå…¥é¢„è§ˆ
- URL å‚æ•°ä¼ é€’ç»„ä»¶ä»£ç ï¼š`/preview?code=<base64_encoded_vue_sfc>`
- æˆ–ä½¿ç”¨ postMessage API è¿›è¡Œè·¨ iframe é€šä¿¡

**Alternatives considered:**
- å¤ç”¨æ•´ä¸ª React åº”ç”¨ï¼šè¿‡é‡ï¼Œå¼•å…¥ä¸å¿…è¦çš„ React ä¾èµ–
- ä½¿ç”¨ Web Componentï¼šå¢åŠ å¤æ‚åº¦ï¼Œæ— æ˜æ˜¾æ”¶ç›Š

### Decision 3: Streamlit é¡µé¢ç»“æ„

ä¿æŒä¸ç°æœ‰ React åº”ç”¨ç›¸åŒçš„ç”¨æˆ·æµç¨‹ï¼š

| ç°æœ‰ React é¡µé¢ | Streamlit ç­‰ä»·å®ç° |
|----------------|-------------------|
| `HomePage.tsx` | `pages/1_ğŸ _é¦–é¡µ.py` - `st.text_area` + `st.button` |
| `OutlinePage.tsx` | `pages/2_ğŸ“_å¤§çº²ç¼–è¾‘.py` - `st_ace` ä»£ç ç¼–è¾‘å™¨ |
| `GeneratingPage.tsx` | `pages/3_â³_ç”Ÿæˆä¸­.py` - `st.progress` + `st.status` |
| `ResultPage.tsx` | `pages/4_ğŸ‰_ç»“æœ.py` - `st.tabs` + iframe é¢„è§ˆ |
| `SettingsPage.tsx` | `pages/5_âš™ï¸_è®¾ç½®.py` - `st.selectbox` + `st.slider` |

**Session ç®¡ç†:**
- ä½¿ç”¨ `st.session_state` å­˜å‚¨ `session_id`
- é¡µé¢é—´é€šè¿‡ query params ä¼ é€’ session_id

### Decision 4: Markdown ç¼–è¾‘å™¨é€‰æ‹©

ä½¿ç”¨ `streamlit-ace` æ›¿ä»£ CodeMirrorï¼š

```python
from streamlit_ace import st_ace

outline = st_ace(
    value=current_outline,
    language="markdown",
    theme="github",
    height=400,
    key="outline_editor"
)
```

**Alternatives considered:**
- `st.text_area`ï¼šåŠŸèƒ½è¿‡äºç®€å•ï¼Œæ— è¯­æ³•é«˜äº®
- `streamlit-code-editor`ï¼šåŠŸèƒ½ä¸ st_ace ç›¸è¿‘ï¼Œä½†ç¤¾åŒºæ´»è·ƒåº¦ä½

## Risks / Trade-offs

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| Streamlit æ€§èƒ½ç“¶é¢ˆ | ä¸­ | æ¯æ¬¡ç”¨æˆ·äº¤äº’é‡æ–°æ¸²æŸ“ï¼›ä½¿ç”¨ `@st.cache_data` ç¼“å­˜ API å“åº” |
| iframe è·¨åŸŸé€šä¿¡å¤æ‚ | ä½ | åŒä¸€ docker-compose ç½‘ç»œï¼›nginx ç»Ÿä¸€ä»£ç† |
| Streamlit ç»„ä»¶ç”Ÿæ€æœ‰é™ | ä½ | æ ¸å¿ƒåŠŸèƒ½å·²è¦†ç›–ï¼›å¯é€šè¿‡ `st.components.v1` æ‰©å±• |
| éƒ¨ç½²å¤æ‚åº¦å¢åŠ  | ä½ | Docker Compose ç»Ÿä¸€ç®¡ç†ï¼›CI/CD æ— éœ€å˜æ›´ |

## Migration Plan

1. **Phase 1: å¹¶è¡Œè¿è¡Œ**
   - æ–°å¢ Streamlit æœåŠ¡ï¼Œä¸åˆ é™¤ React å‰ç«¯
   - é€šè¿‡ nginx è·¯ç”± `/new` æŒ‡å‘ Streamlit
   - ç”¨æˆ·å¯é€‰æ‹©ä½¿ç”¨æ–°æ—§ç•Œé¢

2. **Phase 2: åŠŸèƒ½å¯¹é½éªŒè¯**
   - ç¡®ä¿æ‰€æœ‰ç”¨æˆ·æµç¨‹åœ¨ Streamlit ä¸­å¯ç”¨
   - æ”¶é›†æ—©æœŸç”¨æˆ·åé¦ˆ

3. **Phase 3: åˆ‡æ¢ä¸æ¸…ç†**
   - å°† Streamlit è®¾ä¸ºé»˜è®¤å…¥å£
   - ä¿ç•™ React å‰ç«¯ä¸€ä¸ªç‰ˆæœ¬å‘¨æœŸï¼ˆå¯é€‰ï¼‰
   - æœ€ç»ˆç§»é™¤ React ä»£ç 

**Rollback:**
- Docker Compose ä¸­æ³¨é‡Šæ‰ Streamlit æœåŠ¡
- nginx è·¯ç”±æ¢å¤åˆ° React å‰ç«¯
- é›¶ä»£ç ä¿®æ”¹å›æ»š

## Open Questions

1. **Streamlit æ˜¯å¦æ”¯æŒè‡ªå®šä¹‰åŸŸåè·¯ç”±ï¼Ÿ** - éœ€è¦éªŒè¯ nginx ä»£ç†é…ç½®
2. **Vue Preview Service çš„ä»£ç å¤§å°é™åˆ¶ï¼Ÿ** - URL å‚æ•°æœ‰é•¿åº¦é™åˆ¶ï¼Œå¯èƒ½éœ€è¦ postMessage æ–¹æ¡ˆ
3. **Streamlit ç‰ˆæœ¬å…¼å®¹æ€§** - éœ€ç¡®è®¤ `streamlit >= 1.28` æ”¯æŒçš„ç‰¹æ€§