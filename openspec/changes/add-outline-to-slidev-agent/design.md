# Design: 需求大纲转Slidev PPT Agent系统

## Context

### 背景
- 用户希望通过自然语言描述快速生成演示文稿
- 需要支持迭代式需求细化，允许人类参与修改
- 利用LLM能力生成高质量的前端组件
- 最终输出为Slidev兼容格式，方便版本控制和自定义

### 约束
- 支持多种LLM后端（OpenAI兼容API、Gemini等），需要处理API限流和错误
- Vue SFC组件需要符合Slidev的渲染要求
- 需要保持生成过程的可中断和可恢复性

### 利益相关者
- 终端用户：需要快速制作PPT的任何人
- 开发者：需要维护和扩展系统

## Goals / Non-Goals

### Goals
- 提供直观的Web界面进行需求输入和大纲编辑
- 实现可靠的Markdown大纲生成和解析
- 生成高质量Vue SFC组件
- 自动生成原生Slidev Markdown并引用Vue组件
- 支持完整的编辑-预览-导出工作流

### Non-Goals
- 不支持实时协作编辑
- 不支持除Slidev外的其他PPT格式导出
- 不提供PPT模板市场功能
- 不处理视频/音频等多媒体嵌入

## System Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Web Frontend                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐ │
│  │ 需求输入  │  │ 大纲编辑  │  │ 预览面板  │  │   Slidev导出    │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Python FastAPI Backend                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    Agent Orchestrator                      │  │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐  │  │
│  │  │ 大纲生成Agent│ │ Vue生成Agent│ │  Slidev组装Agent   │  │  │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘   │
│                              │                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    Core Services                           │  │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐  │  │
│  │  │ 大纲解析器   │ │ 组件生成器   │ │    格式组装器      │  │  │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     External Services                            │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                   Gemini 3 Pro API                         │  │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## Data Flow

```
用户需求文本
    │
    ▼
┌─────────────────┐
│  大纲生成Agent   │ ──▶ LLM Prompt: 需求分析+大纲模板
└─────────────────┘
    │
    ▼
Markdown大纲 ◀──────────┐
    │                   │
    ▼                   │
┌─────────────────┐     │
│   用户审核/修改   │ ────┘ [循环直到用户确认]
└─────────────────┘
    │
    ▼
确定的大纲
    │
    ▼
┌─────────────────┐
│  Vue生成Agent   │ ──▶ LLM Prompt: 大纲→Vue SFC
└─────────────────┘
    │
    ▼
Vue组件代码
    │
    ▼
┌─────────────────┐
│ Slidev组装Agent │ ──▶ 生成Slidev Markdown并引用组件
└─────────────────┘
    │
    ▼
slides.md + .vue 输出
```

## Decisions

### Decision 1: 使用Python FastAPI作为后端
- **选择**: FastAPI
- **原因**:
  - 项目已配置Python环境
  - 优秀的异步支持，适合LLM API调用
  - 自动OpenAPI文档生成
- **替代方案**:
  - Node.js Express: 放弃，因为项目已是Python项目
  - Django: 放弃，过于重量级

### Decision 2: Markdown作为中间大纲格式
- **选择**: 结构化Markdown
- **原因**:
  - 人类可读可编辑
  - 易于解析和生成
  - 与Slidev天然兼容
- **替代方案**:
  - JSON: 放弃，用户编辑不友好
  - YAML: 放弃，对嵌套内容支持不如Markdown直观

### Decision 3: Agent编排框架
- **选择**: LangGraph
- **原因**:
  - 内置 `interrupt_before` 支持人工审核断点，完美匹配大纲审核循环
  - 状态持久化，支持工作流中断和恢复
  - LangChain生态系统丰富，集成简单
  - 生产就绪，有完善的调试和监控工具
  - GitHub 19k+ stars，社区活跃
- **替代方案**:
  - CrewAI: 角色驱动模式适合团队协作，但对精细工作流控制不如LangGraph
  - AutoGen: 灵活的多Agent对话，但更适合研究原型
  - 原生实现: 放弃，需要自己实现状态管理和断点逻辑

### Decision 4: LLM后端支持
- **选择**: 多后端支持（OpenAI兼容API + Gemini）
- **原因**:
  - 用户可能有不同的API提供商偏好
  - 自托管模型（如vLLM、Ollama）通常暴露OpenAI兼容端点
  - 降低供应商锁定风险
- **实现方式**:
  - 使用LangChain的ChatOpenAI（支持自定义base_url）
  - 使用LangChain的ChatGoogleGenerativeAI
  - 配置项：api_type, api_base, api_key, model_name
- **替代方案**:
  - 仅Gemini: 放弃，限制用户选择
  - 仅OpenAI: 放弃，同上

### Decision 5: Vue SFC生成策略
- **选择**: 单页面单组件（Vue SFC）
- **原因**:
  - 输出即为Slidev原生组件
  - 组件命名清晰，便于引用与预览
  - 便于用户单独修改某一页
- **替代方案**:
  - 直接在slides.md内联复杂布局: 放弃，难以维护
  - 完整SPA应用: 放弃，复杂度过高

### Decision 6: 按页并发生成与轮询
- **选择**: 后端按页并发生成组件与Markdown片段，前端继续轮询获取进度与增量结果
- **原因**:
  - 减少单次等待时间
  - 兼容现有轮询机制，改造成本低
- **替代方案**:
  - SSE/WebSocket: 暂不采用，增加部署复杂度

## Risks / Trade-offs

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Gemini API限流 | 生成中断 | 实现请求队列和重试机制 |
| 生成的Vue代码不可用 | 渲染/组装失败 | 添加SFC语法验证和自动修复 |
| 并发生成引发限流 | 生成变慢或失败 | 增加并发上限与退避重试 |
| 大纲结构解析失败 | 流程中断 | 定义严格的模板格式，提供示例 |
| Slidev格式兼容性问题 | 渲染异常 | 内置Slidev语法验证器 |

## Migration Plan

不适用 - 这是新功能开发

## LLM Provider Configuration

### 支持的配置项

```python
# 配置示例
llm_config = {
    "provider": "openai",  # openai | gemini | azure
    "base_url": "https://api.openai.com/v1",  # 自定义端点
    "api_key": "sk-xxx",
    "model": "gpt-4o",
    "temperature": 0.7,
    "max_tokens": 4096,
}

# OpenAI兼容端点示例
# - vLLM: http://localhost:8000/v1
# - Ollama: http://localhost:11434/v1
# - Azure OpenAI: https://{resource}.openai.azure.com
# - 第三方代理: https://api.openrouter.ai/api/v1
```

### LangGraph工作流示意

```
┌─────────────────────────────────────────────────────────────┐
│                    LangGraph StateGraph                      │
│                                                              │
│  ┌──────────┐    ┌──────────────┐    ┌─────────────────┐    │
│  │  START   │───▶│ 生成大纲      │───▶│ interrupt_before │    │
│  └──────────┘    └──────────────┘    │ 人工审核断点     │    │
│                                       └────────┬────────┘    │
│                         ┌──────────────────────┘             │
│                         ▼                                    │
│                  ┌─────────────┐                             │
│                  │ 用户确认?    │                             │
│                  └──────┬──────┘                             │
│            ┌────────────┴────────────┐                       │
│            ▼                         ▼                       │
│     ┌──────────────┐          ┌──────────────┐              │
│     │ 增补需求      │          │ 生成Vue      │              │
│     │ 返回大纲生成  │          │ 组件         │              │
│     └──────────────┘          └──────┬───────┘              │
│                                       ▼                      │
│                               ┌──────────────┐              │
│                               │ Slidev组装   │              │
│                               └──────┬───────┘              │
│                                       ▼                      │
│                               ┌──────────────┐              │
│                               │    END       │              │
│                               └──────────────┘              │
└─────────────────────────────────────────────────────────────┘
```

## Open Questions

1. 是否需要支持多种Slidev主题选择？
2. 生成的Vue组件是否需要持久化存储？
3. 是否需要支持增量编辑已生成的slides？
4. ~~API密钥管理策略：用户自带 vs 平台统一？~~ ✅ 已决定：用户自带，支持多种后端
